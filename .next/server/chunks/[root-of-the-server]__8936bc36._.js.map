{"version":3,"sources":["turbopack:///[project]/lib/rls.ts"],"sourcesContent":["import { auth } from \"@/lib/auth\";\n\n// User scope interface\nexport interface UserScope {\n  scope: 'superadmin' | 'national' | 'region' | 'university' | 'smallgroup' | 'alumnismallgroup';\n  regionId?: number | null;\n  universityId?: number | null;\n  smallGroupId?: number | null;\n  alumniGroupId?: number | null;\n}\n\n// RLS conditions interface\nexport interface RLSConditions {\n  regionId?: number;\n  universityId?: number;\n  smallGroupId?: number;\n  alumniGroupId?: number;\n}\n\n/**\n * Get the current user's scope from the session\n * Returns the most restrictive scope if user has multiple roles\n */\nexport async function getUserScope(): Promise<UserScope | null> {\n  try {\n    const session = await auth();\n    \n    if (!session?.user?.roles || session.user.roles.length === 0) {\n      return null;\n    }\n\n    // Get the most restrictive scope (highest priority)\n    const roles = session.user.roles;\n    \n    // Priority order: superadmin > national > region > university > smallgroup > alumnismallgroup\n    const scopePriority = {\n      'superadmin': 1,\n      'national': 2,\n      'region': 3,\n      'university': 4,\n      'smallgroup': 5,\n      'alumnismallgroup': 6\n    };\n\n    // Find the role with the highest priority (most restrictive)\n    const primaryRole = roles.reduce((prev, current) => {\n      const prevPriority = scopePriority[prev.scope as keyof typeof scopePriority] || 999;\n      const currentPriority = scopePriority[current.scope as keyof typeof scopePriority] || 999;\n      return currentPriority < prevPriority ? current : prev;\n    });\n\n    return {\n      scope: primaryRole.scope as UserScope['scope'],\n      regionId: primaryRole.regionId,\n      universityId: primaryRole.universityId,\n      smallGroupId: primaryRole.smallGroupId,\n      alumniGroupId: primaryRole.alumniGroupId\n    };\n  } catch (error) {\n    console.error('Error getting user scope:', error);\n    return null;\n  }\n}\n\n/**\n * Generate RLS conditions based on user scope\n * Returns an object with the appropriate WHERE conditions for database queries\n */\nexport function generateRLSConditions(userScope: UserScope): RLSConditions {\n  const conditions: RLSConditions = {};\n\n  // Superadmin has access to everything - no conditions needed\n  if (userScope.scope === 'superadmin') {\n    return conditions;\n  }\n\n  // National scope - access to all regions (no filtering needed for now)\n  if (userScope.scope === 'national') {\n    return conditions;\n  }\n\n  // Region scope - access to specific region and all its children\n  if (userScope.scope === 'region' && userScope.regionId) {\n    conditions.regionId = userScope.regionId;\n    return conditions;\n  }\n\n  // University scope - access to specific university and its small groups\n  if (userScope.scope === 'university' && userScope.universityId) {\n    conditions.universityId = userScope.universityId;\n    // Also include regionId for consistency\n    if (userScope.regionId) {\n      conditions.regionId = userScope.regionId;\n    }\n    return conditions;\n  }\n\n  // Small group scope - access to specific small group only\n  if (userScope.scope === 'smallgroup' && userScope.smallGroupId) {\n    conditions.smallGroupId = userScope.smallGroupId;\n    // Include parent IDs for consistency\n    if (userScope.universityId) {\n      conditions.universityId = userScope.universityId;\n    }\n    if (userScope.regionId) {\n      conditions.regionId = userScope.regionId;\n    }\n    return conditions;\n  }\n\n  // Alumni small group scope - access to specific alumni group only\n  if (userScope.scope === 'alumnismallgroup' && userScope.alumniGroupId) {\n    conditions.alumniGroupId = userScope.alumniGroupId;\n    // Include regionId for consistency\n    if (userScope.regionId) {\n      conditions.regionId = userScope.regionId;\n    }\n    return conditions;\n  }\n\n  // If no valid scope found, return empty conditions (no access)\n  return conditions;\n}\n\n/**\n * Check if user has permission to access a specific resource\n */\nexport function hasPermission(\n  userScope: UserScope,\n  resourceType: 'region' | 'university' | 'smallgroup' | 'alumnismallgroup',\n  resourceId: number\n): boolean {\n  // Superadmin has access to everything\n  if (userScope.scope === 'superadmin') {\n    return true;\n  }\n\n  // National scope has access to everything\n  if (userScope.scope === 'national') {\n    return true;\n  }\n\n  switch (resourceType) {\n    case 'region':\n      return userScope.scope === 'region' && userScope.regionId === resourceId;\n    \n    case 'university':\n      return (userScope.scope === 'university' && userScope.universityId === resourceId) ||\n             (userScope.scope === 'region' && userScope.regionId !== null);\n    \n    case 'smallgroup':\n      return (userScope.scope === 'smallgroup' && userScope.smallGroupId === resourceId) ||\n             (userScope.scope === 'university' && userScope.universityId !== null) ||\n             (userScope.scope === 'region' && userScope.regionId !== null);\n    \n    case 'alumnismallgroup':\n      return (userScope.scope === 'alumnismallgroup' && userScope.alumniGroupId === resourceId) ||\n             (userScope.scope === 'region' && userScope.regionId !== null);\n    \n    default:\n      return false;\n  }\n}\n\n/**\n * Get RLS conditions for specific tables\n * Some tables don't have all the foreign key columns, so we need to map appropriately\n */\nexport function getTableRLSConditions(userScope: UserScope, tableName: string): Record<string, unknown> {\n  const rlsConditions = generateRLSConditions(userScope);\n  \n  switch (tableName) {\n    case 'member':\n    case 'trainings':\n    case 'permanentministryevent':\n    case 'budget':\n    case 'document':\n    case 'contributiondesignation':\n      // These tables have regionId, universityId, smallGroupId, alumniGroupId\n      return rlsConditions;\n    \n    case 'university':\n      // Universities only have regionId\n      return rlsConditions.regionId ? { regionId: rlsConditions.regionId } : {};\n    \n    case 'smallgroup':\n      // Small groups have regionId and universityId\n      return {\n        ...(rlsConditions.regionId && { regionId: rlsConditions.regionId }),\n        ...(rlsConditions.universityId && { universityId: rlsConditions.universityId })\n      };\n    \n    case 'alumnismallgroup':\n      // Alumni groups have regionId\n      return rlsConditions.regionId ? { regionId: rlsConditions.regionId } : {};\n    \n    case 'region':\n      // Regions don't have foreign keys, so we need to check if user has access to specific regions\n      if (userScope.scope === 'region' && userScope.regionId) {\n        return { id: userScope.regionId };\n      }\n      return {};\n    \n    default:\n      return rlsConditions;\n  }\n}\n"],"names":[],"mappings":"mjDAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAuBO,eAAe,IACpB,GAAI,CACF,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,IAAA,AAAI,IAE1B,GAAI,CAAC,GAAS,MAAM,OAAuC,GAAG,CAAjC,EAAQ,IAAI,CAAC,KAAK,CAAC,MAAM,CACpD,OAAO,KAIT,IAAM,EAAQ,EAAQ,IAAI,CAAC,KAAK,CAG1B,EAAgB,CACpB,WAAc,EACd,SAAY,EACZ,OAAU,EACV,WAAc,EACd,WAAc,EACd,iBAAoB,CACtB,EAGM,EAAc,EAAM,MAAM,CAAC,CAAC,EAAM,KACtC,IAAM,EAAe,CAAa,CAAC,EAAK,KAAK,CAA+B,EAAI,IAEhF,MAAO,CADiB,CAAa,CAAC,EAAQ,KAAK,CAA+B,EAAI,GAAA,EAC7D,EAAe,EAAU,CACpD,GAEA,MAAO,CACL,MAAO,EAAY,KAAK,CACxB,SAAU,EAAY,QAAQ,CAC9B,aAAc,EAAY,YAAY,CACtC,aAAc,EAAY,YAAY,CACtC,cAAe,EAAY,aAAa,AAC1C,CACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,4BAA6B,GACpC,IACT,CACF,CAMO,SAAS,EAAsB,CAAoB,EACxD,IAAM,EAA4B,CAAC,QAGX,cAAc,CAAlC,EAAU,KAAK,EAKK,YAAY,CAAhC,EAAU,KAAK,GAKK,WAApB,EAAU,KAAK,EAAiB,EAAU,QAAQ,CACpD,CADsD,CAC3C,QAAQ,CAAG,EAAU,QAAQ,CAKtC,AAAoB,iBAAV,KAAK,EAAqB,EAAU,YAAY,EAAE,AAC9D,EAAW,YAAY,CAAG,EAAU,YAAY,CAE5C,EAAU,QAAQ,EAAE,CACtB,EAAW,QAAQ,CAAG,EAAU,QAAA,AAAQ,GAMxC,AAAoB,iBAAV,KAAK,EAAqB,EAAU,YAAY,EAC5D,AAD8D,EACnD,YAAY,CAAG,EAAU,YAAY,CAE5C,EAAU,YAAY,EAAE,CAC1B,EAAW,YAAY,CAAG,EAAU,YAAA,AAAY,EAE9C,EAAU,QAAQ,EAAE,AACtB,GAAW,QAAQ,CAAG,EAAU,QAAA,AAAQ,GAMpB,qBAApB,EAAU,KAAK,EAA2B,EAAU,aAAa,EAAE,CACrE,EAAW,aAAa,CAAG,EAAU,aAAa,CAE9C,EAAU,QAAQ,EAAE,CACtB,EAAW,QAAQ,CAAG,EAAU,QAAA,AAAQ,IA1CnC,CAiDX,CA8CO,SAAS,EAAsB,CAAoB,CAAE,CAAiB,EAC3E,IAAM,EAAgB,EAAsB,GAE5C,OAAQ,GACN,IAAK,SACL,IAAK,YACL,IAAK,yBACL,IAAK,SACL,IAAK,WACL,IAAK,0BA0BL,QAxBE,OAAO,CAET,KAAK,aAWL,IAAK,mBATH,OAAO,EAAc,QAAQ,CAAG,CAAE,SAAU,EAAc,QAAQ,AAAC,EAAI,CAAC,CAE1E,KAAK,aAEH,MAAO,CACL,GAAI,EAAc,QAAQ,EAAI,CAAE,SAAU,EAAc,QAAQ,AAAC,CAAC,CAClE,GAAI,EAAc,YAAY,EAAI,CAAE,aAAc,EAAc,YAAY,AAAC,CAC/E,AADgF,CAOlF,KAAK,SAEH,GAAwB,WAApB,EAAU,KAAK,EAAiB,EAAU,QAAQ,CACpD,CADsD,KAC/C,CAAE,GAAI,EAAU,QAAQ,AAAC,EAElC,MAAO,CAAC,CAIZ,CACF"}