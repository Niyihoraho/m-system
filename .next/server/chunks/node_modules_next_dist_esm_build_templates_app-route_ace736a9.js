module.exports=[97705,e=>{"use strict";e.s(["handler",()=>G,"patchFetch",()=>F,"routeModule",()=>P,"serverHooks",()=>H,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>D],97705);var t=e.i(47909),n=e.i(74017),r=e.i(96250),a=e.i(59756),o=e.i(61916),i=e.i(69741),s=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),d=e.i(66012),m=e.i(70101),g=e.i(26937),p=e.i(10372),h=e.i(93695);e.i(52474);var v=e.i(220);e.s(["GET",()=>b],35996);var w=e.i(89171),f=e.i(15270),E=e.i(91773);async function b(e){try{let t=await (0,E.getUserScope)();if(!t)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:n}=new URL(e.url),r=n.get("regionId"),a=n.get("universityId"),o=n.get("smallGroupId"),i=n.get("alumniGroupId"),s=n.get("dateFrom"),l=n.get("dateTo");n.get("engagementType");let u=n.get("selectedEvent"),c=n.get("selectedDesignation"),d=(0,E.generateRLSConditions)(t),m={...d};if(r&&"all"!==r){let e=Number(r);if(d.regionId&&e!==d.regionId)return w.NextResponse.json({error:"Access denied to requested region"},{status:403});m.regionId=e}if(a&&"all"!==a){let e=Number(a);if(d.universityId&&e!==d.universityId)return w.NextResponse.json({error:"Access denied to requested university"},{status:403});m.universityId=e}if(o&&"all"!==o){let e=Number(o);if(d.smallGroupId&&e!==d.smallGroupId)return w.NextResponse.json({error:"Access denied to requested small group"},{status:403});m.smallGroupId=e}if(i&&"all"!==i){let e=Number(i);if(d.alumniGroupId&&e!==d.alumniGroupId)return w.NextResponse.json({error:"Access denied to requested alumni group"},{status:403});m.alumniGroupId=e}if(s||l){if(m.createdAt={},s){let e=new Date(s);e.setHours(0,0,0,0),m.createdAt.gte=e}if(l){let e=new Date(l);e.setHours(23,59,59,999),m.createdAt.lte=e}}let g=await y(m,u),p=await R(m,c),h=await I(m,s,l),v=await A(m,r,a),f=await M(m),b=await N(m),x={totalEngagement:g.totalAttendance+p.totalContributions,averageEngagementRate:function(e,t){let n=e.totalAttendance+t.totalContributions,r=e.events.length+t.contributions.length;return r>0?Math.round(n/r*100):0}(g,p),eventParticipation:g.totalAttendance,designationParticipation:p.totalContributions,monthlyGrowth:function(e){if(e.length<2)return 0;let t=e[e.length-1],n=e[e.length-2];return 0===n.totalEngagement?0:Math.round((t.totalEngagement-n.totalEngagement)/n.totalEngagement*100)}(h)},P={keyMetrics:x,engagementTrends:h,engagementTypeDistribution:f,regionalEngagement:v,eventEngagementLevels:b};return 0===x.totalEngagement&&0===x.eventParticipation&&0===x.designationParticipation&&(await C(m)||(P.keyMetrics={totalEngagement:0,averageEngagementRate:0,eventParticipation:0,designationParticipation:0,monthlyGrowth:0},P.engagementTrends=[],P.engagementTypeDistribution=[{name:"Events",value:0,color:"#3B82F6",count:0},{name:"Designations",value:0,color:"#10B981",count:0}],P.regionalEngagement=[],P.eventEngagementLevels=[{name:"High Engagement",value:0,color:"#10B981",count:0},{name:"Medium Engagement",value:0,color:"#F59E0B",count:0},{name:"Low Engagement",value:0,color:"#EF4444",count:0}])),w.NextResponse.json(P,{status:200})}catch(e){return console.error("Error fetching engagement analytics:",e),w.NextResponse.json({error:"Failed to fetch engagement analytics"},{status:500})}}async function y(e,t){try{let n={...e};t&&"all"!==t&&(n.id=Number(t));let r=await f.prisma.permanentministryevent.findMany({where:n,include:{attendance:{where:{status:"present"},include:{member:{select:{id:!0,firstname:!0,secondname:!0,regionId:!0,universityId:!0,smallGroupId:!0,alumniGroupId:!0}}}}}}),a=await f.prisma.trainings.findMany({where:n,include:{attendance:{where:{status:"present"},include:{member:{select:{id:!0,firstname:!0,secondname:!0,regionId:!0,universityId:!0,smallGroupId:!0,alumniGroupId:!0}}}}}});return{totalAttendance:r.reduce((e,t)=>e+t.attendance.length,0)+a.reduce((e,t)=>e+t.attendance.length,0),permanentEvents:r.length,trainingEvents:a.length,events:[...r,...a]}}catch(e){return console.error("Error fetching event attendance data:",e),{totalAttendance:0,permanentEvents:0,trainingEvents:0,events:[]}}}async function R(e,t){try{let n=await f.prisma.contribution.findMany({where:{designationId:t&&"all"!==t?Number(t):void 0,status:"completed",member:{...e}},include:{contributiondesignation:!0,member:{select:{id:!0,firstname:!0,secondname:!0,regionId:!0,universityId:!0,smallGroupId:!0,alumniGroupId:!0}}}}),r=n.length,a=n.reduce((e,t)=>e+t.amount,0);return{totalContributions:r,totalAmount:a,contributions:n}}catch(e){return console.error("Error fetching designation data:",e),{totalContributions:0,totalAmount:0,contributions:[]}}}async function I(e,t,n){try{let t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];new Date().getMonth();let n=[];for(let r=11;r>=0;r--){let a=new Date;a.setMonth(a.getMonth()-r),a.setDate(1),a.setHours(0,0,0,0);let o=new Date(a);o.setMonth(o.getMonth()+1),o.setDate(0),o.setHours(23,59,59,999);let i=await f.prisma.attendance.count({where:{status:"present",recordedAt:{gte:a,lte:o},member:e}}),s=await f.prisma.contribution.count({where:{status:"completed",createdAt:{gte:a,lte:o},member:e}}),l=await f.prisma.member.count({where:{...e,status:"active",createdAt:{lte:o}}}),u=i+s,c=l>0?Math.round(u/l*100):0;n.push({month:t[a.getMonth()],eventAttendance:i,designationParticipation:s,totalEngagement:u,engagementRate:c,activeMembers:l})}return n}catch(e){return console.error("Error fetching monthly trends:",e),[]}}async function A(e,t,n){try{let r=[];if(t&&"all"!==t)for(let n of(await f.prisma.university.findMany({where:{regionId:Number(t)},include:{member:{where:{...e,regionId:Number(t)}}}}))){let a=await f.prisma.attendance.count({where:{status:"present",member:{...e,regionId:Number(t),universityId:n.id}}}),o=await f.prisma.contribution.count({where:{status:"completed",member:{...e,regionId:Number(t),universityId:n.id}}}),i=a+o,s=n.member.length>0?Math.round(i/n.member.length*100):0;r.push({region:n.name,totalEngagement:i,eventEngagement:a,designationEngagement:o,engagementRate:s})}else if(n&&"all"!==n)for(let t of(await f.prisma.smallgroup.findMany({where:{universityId:Number(n)},include:{member:{where:{...e,universityId:Number(n)}}}}))){let a=await f.prisma.attendance.count({where:{status:"present",member:{...e,universityId:Number(n),smallGroupId:t.id}}}),o=await f.prisma.contribution.count({where:{status:"completed",member:{...e,universityId:Number(n),smallGroupId:t.id}}}),i=a+o,s=t.member.length>0?Math.round(i/t.member.length*100):0;r.push({region:t.name,totalEngagement:i,eventEngagement:a,designationEngagement:o,engagementRate:s})}else for(let t of(await f.prisma.region.findMany({where:e.regionId?{id:e.regionId}:{},include:{member:{where:e}}}))){let n=await f.prisma.attendance.count({where:{status:"present",member:{...e,regionId:t.id}}}),a=await f.prisma.contribution.count({where:{status:"completed",member:{...e,regionId:t.id}}}),o=n+a,i=t.member.length>0?Math.round(o/t.member.length*100):0;r.push({region:t.name,totalEngagement:o,eventEngagement:n,designationEngagement:a,engagementRate:i})}return r}catch(e){return console.error("Error fetching regional engagement data:",e),[]}}async function M(e){try{let t=await f.prisma.attendance.count({where:{status:"present",member:e}}),n=await f.prisma.contribution.count({where:{status:"completed",member:e}}),r=t+n;return[{name:"Events",value:r>0?Math.round(t/r*100):0,color:"#3B82F6",count:t},{name:"Designations",value:r>0?Math.round(n/r*100):0,color:"#10B981",count:n}]}catch(e){return console.error("Error fetching engagement type distribution:",e),[{name:"Events",value:0,color:"#3B82F6",count:0},{name:"Designations",value:0,color:"#10B981",count:0}]}}async function N(e){try{let t=await f.prisma.member.findMany({where:e,include:{attendance:{where:{status:"present"}},contribution:{where:{status:"completed"}}}}),n=0,r=0,a=0;t.forEach(e=>{let t=e.attendance.length+e.contribution.length;t>=5?n++:t>=2?r++:a++});let o=t.length;if(0===o)return[{name:"High Engagement",value:0,color:"#10B981",count:0},{name:"Medium Engagement",value:0,color:"#F59E0B",count:0},{name:"Low Engagement",value:0,color:"#EF4444",count:0}];return[{name:"High Engagement",value:Math.round(n/o*100),color:"#10B981",count:n},{name:"Medium Engagement",value:Math.round(r/o*100),color:"#F59E0B",count:r},{name:"Low Engagement",value:Math.round(a/o*100),color:"#EF4444",count:a}]}catch(e){return console.error("Error fetching event engagement levels:",e),[{name:"High Engagement",value:0,color:"#10B981",count:0},{name:"Medium Engagement",value:0,color:"#F59E0B",count:0},{name:"Low Engagement",value:0,color:"#EF4444",count:0}]}}async function C(e){try{let t=await f.prisma.attendance.count({where:{member:e}}),n=await f.prisma.contribution.count({where:{member:e}}),r=await f.prisma.permanentministryevent.count({where:e}),a=await f.prisma.trainings.count({where:e});return t>0||n>0||r>0||a>0}catch(e){return console.error("Error checking for engagement data:",e),!1}}var x=e.i(35996);let P=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/engagement/analytics/route",pathname:"/api/engagement/analytics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/engagement/analytics/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:T,workUnitAsyncStorage:D,serverHooks:H}=P;function F(){return(0,r.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:D})}async function G(e,t,r){var w;let f="/api/engagement/analytics/route";f=f.replace(/\/index$/,"")||"/";let E=await P.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:y,nextConfig:R,isDraftMode:I,prerenderManifest:A,routerServerContext:M,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,resolvedPathname:x}=E,T=(0,i.normalizeAppPath)(f),D=!!(A.dynamicRoutes[T]||A.routes[x]);if(D&&!I){let e=!!A.routes[x],t=A.dynamicRoutes[T];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let H=null;!D||P.isDev||I||(H="/index"===(H=x)?"/":H);let F=!0===P.isDev||!D,G=D&&!F,O=e.method||"GET",S=(0,o.getTracer)(),_=S.getActiveScopeSpan(),B={params:y,prerenderManifest:A,renderOpts:{experimental:{cacheComponents:!!R.experimental.cacheComponents,authInterrupts:!!R.experimental.authInterrupts},supportsDynamicResponse:F,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(w=R.experimental)?void 0:w.cacheLife,isRevalidate:G,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>P.onRequestError(e,t,r,M)},sharedContext:{buildId:b}},U=new s.NodeNextRequest(e),q=new s.NodeNextResponse(t),k=l.NextRequestAdapter.fromNodeNextRequest(U,(0,l.signalFromNodeResponse)(t));try{let i=async n=>P.handle(k,B).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=S.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let e=`${O} ${a}`;n.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),n.updateName(e)}else n.updateName(`${O} ${e.url}`)}),s=async o=>{var s,l;let u=async({previousCacheEntry:n})=>{try{if(!(0,a.getRequestMeta)(e,"minimalMode")&&N&&C&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!D)return await (0,d.sendResponse)(U,q,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[p.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=p.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=p.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:G,isOnDemandRevalidate:N})},M),t}},h=await P.handleResponse({req:e,nextConfig:R,cacheKey:H,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:r.waitUntil});if(!D)return null;if((null==h||null==(s=h.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,a.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",N?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,m.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,a.getRequestMeta)(e,"minimalMode")&&D||w.delete(p.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,g.getCacheControlHeader)(h.cacheControl)),await (0,d.sendResponse)(U,q,new Response(h.value.body,{headers:w,status:h.value.status||200})),null};_?await s(_):await S.withPropagatedContext(e.headers,()=>S.trace(u.BaseServerSpan.handleRequest,{spanName:`${O} ${e.url}`,kind:o.SpanKind.SERVER,attributes:{"http.method":O,"http.target":e.url}},s))}catch(t){if(_||t instanceof h.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:G,isOnDemandRevalidate:N})}),D)throw t;return await (0,d.sendResponse)(U,q,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_ace736a9.js.map